{% extends "base.html" %}

{% block title %}Resultado da An√°lise - The APEX{% endblock %}

{% block content %}
<div class="header" style="display: flex; justify-content: space-between; align-items: center;">
    <div>
        <h1>Resultado da An√°lise</h1>
        <p style="color: var(--text-secondary);">Detalhes da investiga√ß√£o (Vers√£o CORE).</p>
    </div>
    <a href="{{ url_for('main.download_pdf', report_id=report_id) }}" class="btn-action" style="text-decoration: none; display: flex; align-items: center; gap: 8px;">
        <i class="bi bi-file-earmark-pdf-fill"></i> Baixar PDF
    </a>
</div>

<!-- Resumo Executivo -->
<details open>
    <summary>üìÑ Resumo Executivo</summary>
    <div class="details-content">
        <div style="line-height: 1.6;">
            {% if analysis.ai_analysis %}
                {% if analysis.ai_analysis is string %}
                    <p>{{ analysis.ai_analysis }}</p>
                {% elif analysis.ai_analysis.summary %}
                    {{ analysis.ai_analysis.summary | markdown }}
                {% else %}
                    <p>{{ analysis.ai_analysis | tojson }}</p>
                {% endif %}
            {% else %}
                <p style="color: var(--text-secondary);">A an√°lise autom√°tica est√° dispon√≠vel apenas para dados t√©cnicos neste m√≥dulo.</p>
            {% endif %}
        </div>
    </div>
</details>

<!-- Detalhes T√©cnicos do Item -->
<details open>
    <summary>üõ†Ô∏è Detalhes T√©cnicos</summary>
    <div class="details-content">
        <div style="display: grid; grid-template-columns: 200px 1fr; gap: 10px; margin-bottom: 10px;">
            <div style="color: var(--text-secondary); font-weight: 600;">Identificador:</div>
            <div style="font-family: 'Consolas', monospace; word-break: break-all;">{{ analysis.item_identifier }}</div>
        </div>
        
        <div style="display: grid; grid-template-columns: 200px 1fr; gap: 10px; margin-bottom: 10px;">
            <div style="color: var(--text-secondary); font-weight: 600;">Tipo:</div>
            <div><span class="badge bg-secondary">{{ analysis.item_type | capitalize }}</span></div>
        </div>

        <div style="display: grid; grid-template-columns: 200px 1fr; gap: 10px; margin-bottom: 10px;">
            <div style="color: var(--text-secondary); font-weight: 600;">Veredito:</div>
            <div>
                <span class="badge 
                    {% if analysis.final_verdict == 'malicious' %}bg-danger
                    {% elif analysis.final_verdict == 'suspicious' %}bg-warning
                    {% else %}bg-success{% endif %}">
                    {{ analysis.final_verdict | capitalize }}
                </span>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 200px 1fr; gap: 10px; margin-bottom: 10px;">
            <div style="color: var(--text-secondary); font-weight: 600;">Data:</div>
            <div>{{ analysis.created_at | int | strftime('%d/%m/%Y %H:%M:%S') }}</div>
        </div>
    </div>
</details>

{% if analysis.item_type == 'file' %}
    <details open>
        <summary>üìÑ An√°lise de Arquivo</summary>
        <div class="details-content">
            <p><strong>Nome:</strong> {{ analysis.filename }}</p>
            <p><strong>SHA256:</strong> <code style="color: var(--accent-color);">{{ analysis.sha256 }}</code></p>
            <p><strong>Tamanho:</strong> {{ analysis.size_bytes }} bytes</p>
            
            {% if analysis.pe_analysis %}
            <div style="margin-top: 15px; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; border: 1px solid var(--glass-border);">
                <h5 style="color: var(--accent-color);">An√°lise PE</h5>
                <p><strong>DLL Side Loading:</strong> {{ 'Detectado' if analysis.pe_analysis.dll_side_loading else 'N√£o Detectado' }}</p>
                <p><strong>In-Memory Execution:</strong> {{ 'Detectado' if analysis.pe_analysis.in_memory_execution else 'N√£o Detectado' }}</p>
                {% if analysis.pe_analysis.details %}
                <ul style="color: var(--text-secondary);">
                    {% for detail in analysis.pe_analysis.details %}
                        <li>{{ detail }}</li>
                    {% endfor %}
                </ul>
                {% endif %}
            </div>
            {% endif %}

            {% if analysis.strings_snippet %}
            <div style="margin-top: 15px;">
                <h5 style="color: var(--accent-color);">Strings (Amostra)</h5>
                <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 6px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; color: #ccc; white-space: pre-wrap;">{{ analysis.strings_snippet }}</div>
            </div>
            {% endif %}
        </div>
    </details>

{% elif analysis.item_type == 'network' %}
    <details open>
        <summary>üåê Dispositivos na Rede</summary>
        <div class="details-content">
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>IP</th>
                            <th>Hostname / Vendor</th>
                            <th>MAC</th>
                            <th>Portas Abertas</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% set raw = analysis.raw_data %}
                        {% if raw and raw.devices %}
                            {% for dev in raw.devices %}
                            <tr>
                                <td style="color: var(--accent-color); font-weight: bold;">{{ dev.ip }}</td>
                                <td>{{ dev.hostname or dev.vendor or 'Desconhecido' }}</td>
                                <td><small style="font-family: monospace;">{{ dev.mac or '-' }}</small></td>
                                <td>
                                    {% if dev.open_ports %}
                                        {% for port in dev.open_ports %}
                                            <span class="badge bg-info">{{ port }}</span>
                                        {% endfor %}
                                    {% else %}
                                        <span style="color: var(--text-secondary);">Nenhuma</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr><td colspan="4" style="text-align: center;">Nenhum dispositivo encontrado ou dados indispon√≠veis.</td></tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </details>

{% elif analysis.item_type == 'audit' %}
    <details open>
        <summary>üõ°Ô∏è Auditoria do Sistema (Simplificada)</summary>
        <div class="details-content">
            {% set audit = analysis.raw_data %}
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
                <div style="background: rgba(0,223,216,0.1); padding: 15px; border-radius: 12px; border: 1px solid var(--accent-color);">
                    <div style="color: var(--text-secondary); font-size: 0.9em;">Processos Ativos</div>
                    <div style="font-size: 2em; font-weight: bold; color: #fff;">{{ audit.processes_count or 0 }}</div>
                </div>
                <div style="background: rgba(0,223,216,0.1); padding: 15px; border-radius: 12px; border: 1px solid var(--accent-color);">
                    <div style="color: var(--text-secondary); font-size: 0.9em;">Servi√ßos Ativos</div>
                    <div style="font-size: 2em; font-weight: bold; color: #fff;">{{ audit.services_count or 0 }}</div>
                </div>
            </div>

            <h5 style="color: var(--accent-color); margin-top: 20px;">Hardening do Windows</h5>
            <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; border: 1px solid var(--glass-border); margin-bottom: 20px;">
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 10px;">
                    {% for key, val in audit.hardening.items() %}
                        <div style="display: flex; justify-content: space-between; padding: 5px; border-bottom: 1px solid rgba(255,255,255,0.05);">
                            <span style="color: var(--text-secondary);">{{ key }}:</span>
                            <span style="font-weight: bold; color: {% if val == true %}#28a745{% elif val == false %}#dc3545{% else %}#fff{% endif %};">
                                {{ 'Habilitado' if val == true else ('Desabilitado' if val == false else val) }}
                            </span>
                        </div>
                    {% endfor %}
                </div>
            </div>

            <h5 style="color: var(--accent-color);">Informa√ß√µes da M√°quina</h5>
            <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; border: 1px solid var(--glass-border);">
                {% for key, val in audit.machine_info.items() %}
                    <p style="margin-bottom: 5px;"><strong style="color: var(--text-secondary);">{{ key | capitalize }}:</strong> {{ val }}</p>
                {% endfor %}
            </div>
        </div>
    </details>

{% endif %}

<div style="margin-top: 30px; display: flex; gap: 15px;">
    <a href="{{ url_for('main.inicio') }}" class="btn-action" style="text-decoration: none; background: rgba(255,255,255,0.1);">üè† In√≠cio</a>
    <a href="{{ url_for('main.history') }}" class="btn-action" style="text-decoration: none;">üïí Hist√≥rico</a>
</div>

{% endblock %}

{% block head %}
<style>
    details {
        margin-bottom: 20px;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid var(--glass-border);
        border-radius: 12px;
        overflow: hidden;
    }
    summary {
        padding: 15px 20px;
        cursor: pointer;
        font-weight: 600;
        background: rgba(255, 255, 255, 0.02);
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .details-content {
        padding: 20px;
        border-top: 1px solid var(--glass-border);
    }
    .table {
        width: 100%;
        color: #fff;
        border-collapse: collapse;
    }
    .table th, .table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .badge {
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 0.8em;
    }
    .bg-danger { background: #dc3545; }
    .bg-warning { background: #ffc107; color: #000; }
    .bg-success { background: #28a745; }
    .bg-secondary { background: #6c757d; }
    .bg-info { background: #17a2b8; }
</style>
{% endblock %}
