{% extends "base.html" %}

{% block content %}
<div class="header">
    <h1 id="module-title">
        {% if module == 'network' %}Network Monitor
        {% elif module == 'audit' %}System Audit
        {% else %}Malware Analyzer{% endif %}
    </h1>
    <p style="color: var(--text-secondary);">
        {% if module == 'network' %}An√°lise de Ativos na Rede Local
        {% elif module == 'audit' %}Auditoria de Seguran√ßa Simplificada
        {% else %}M√≥dulo de Seguran√ßa Ativa{% endif %}
    </p>
</div>

{% if module == 'malware' or not module %}
<div id="module-malware" class="module-section">
    <div class="glass-card">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid var(--glass-border);">
            <div style="width: 40px; height: 40px; border-radius: 10px; background: rgba(220, 53, 69, 0.1); display: flex; align-items: center; justify-content: center; border: 1px solid rgba(220, 53, 69, 0.2);">
                <i class="bi bi-bug-fill" style="color: #ff4d4d; font-size: 20px;"></i>
            </div>
            <div>
                <h3 style="margin: 0; font-size: 16px; font-weight: 600;">Malware Analyzer</h3>
                <p style="margin: 0; font-size: 12px; color: var(--text-secondary);">An√°lise profunda de artefatos suspeitos</p>
            </div>
        </div>

        <!-- Upload de Arquivo -->
        <div style="margin-bottom: 30px; background: rgba(0,0,0,0.2); padding: 20px; border-radius: 16px; border: 1px solid var(--glass-border);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h4 style="margin: 0; color: #fff; font-size: 14px; font-weight: 600;">üìÅ An√°lise de Arquivo</h4>
                <span id="status-badge-malware" class="status-badge status-idle">Aguardando</span>
            </div>
            <div style="display: flex; gap: 10px; align-items: center;">
                 <div style="display:none;">
                    <option value="groq" selected>Groq Llama</option>
                 </div>
                <button class="action-btn" onclick="document.getElementById('file-upload').click()" style="flex: 1;">SELECIONAR EXECUT√ÅVEL OU SCRIPT</button>
                <input type="file" id="file-upload" style="display: none" onchange="handleFileSelect(this)">
            </div>
            <div class="console-output" id="output-malware" style="margin-top: 15px; font-size: 11px; color: var(--text-secondary); background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px;">
                <i class="bi bi-info-circle" style="margin-right: 5px;"></i> Suporta .exe, .dll, .py, .ps1, .bin
            </div>
        </div>

        <!-- An√°lise de URL -->
        <div style="background: rgba(0,0,0,0.2); padding: 20px; border-radius: 16px; border: 1px solid var(--glass-border);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h4 style="margin: 0; color: #fff; font-size: 14px; font-weight: 600;">üåê An√°lise de URL</h4>
                <span class="status-badge status-idle" id="status-badge-url">Pronto</span>
            </div>
            <div style="display:flex; gap:10px;">
                <input id="url-input" class="form-control" placeholder="https://exemplo.com/malware" style="flex: 1; margin-bottom: 0;">
                <button class="action-btn" onclick="analyzeUrl()">ANALISAR URL</button>
            </div>
            <div class="console-output" id="output-url" style="margin-top: 15px; font-size: 11px; color: var(--text-secondary); background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px;">
                <i class="bi bi-shield-check" style="margin-right: 5px;"></i> Verifica√ß√£o em tempo real com reputa√ß√£o global.
            </div>
        </div>
    </div>
</div>
{% endif %}



{% if module == 'network' %}
<div id="module-network" class="module-section">
    <div class="glass-card">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid var(--glass-border);">
            <div style="width: 40px; height: 40px; border-radius: 10px; background: rgba(0, 223, 216, 0.1); display: flex; align-items: center; justify-content: center; border: 1px solid rgba(0, 223, 216, 0.2);">
                <i class="bi bi-broadcast-pin" style="color: var(--accent-color); font-size: 20px;"></i>
            </div>
            <div>
                <h3 style="margin: 0; font-size: 16px; font-weight: 600;">Network Monitor</h3>
                <p style="margin: 0; font-size: 12px; color: var(--text-secondary);">Varredura e identifica√ß√£o de ativos locais</p>
            </div>
        </div>

        <div style="background: rgba(0,0,0,0.2); padding: 20px; border-radius: 16px; border: 1px solid var(--glass-border);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h4 style="margin: 0; color: #fff; font-size: 14px; font-weight: 600;">üîç Varredura de Rede</h4>
                <span id="status-badge-network" class="status-badge status-idle">Pronto</span>
            </div>
            <div style="display:flex; gap:10px; margin-bottom: 15px;">
                <input id="network-cidr" class="form-control" placeholder="Ex: 192.168.1.0/24" style="flex: 1; margin-bottom: 0;">
                <button class="action-btn" onclick="runNetworkScan('quick')">VARREDURA R√ÅPIDA</button>
            </div>
            <div class="console-output" id="output-network" style="min-height: 100px; font-size: 11px; color: var(--text-secondary); background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; font-family: 'JetBrains Mono', monospace;">
                [INFO] Clique em Varredura R√°pida para iniciar.
            </div>
        </div>
    </div>
</div>
{% endif %}

{% if module == 'audit' %}
<div id="module-audit" class="module-section">
    <div class="glass-card">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid var(--glass-border);">
            <div style="width: 40px; height: 40px; border-radius: 10px; background: rgba(25, 135, 84, 0.1); display: flex; align-items: center; justify-content: center; border: 1px solid rgba(25, 135, 84, 0.2);">
                <i class="bi bi-shield-check" style="color: #198754; font-size: 20px;"></i>
            </div>
            <div>
                <h3 style="margin: 0; font-size: 16px; font-weight: 600;">System Audit</h3>
                <p style="margin: 0; font-size: 12px; color: var(--text-secondary);">Verifica√ß√£o de conformidade e seguran√ßa local</p>
            </div>
        </div>

        <div style="background: rgba(0,0,0,0.2); padding: 20px; border-radius: 16px; border: 1px solid var(--glass-border);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h4 style="margin: 0; color: #fff; font-size: 14px; font-weight: 600;">üõ°Ô∏è Auditoria Simplificada</h4>
                <span id="status-badge-audit" class="status-badge status-idle">Pronto</span>
            </div>
            <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 20px;">
                Esta vers√£o Core realiza uma auditoria r√°pida de seguran√ßa, verificando o status do firewall, informa√ß√µes da m√°quina e contagem de processos/servi√ßos ativos.
            </p>
            <button class="action-btn" onclick="runAuditScan()" style="width: 100%;">INICIAR AUDITORIA</button>
            <div class="console-output" id="output-audit" style="margin-top: 15px; min-height: 80px; font-size: 11px; color: var(--text-secondary); background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; font-family: 'JetBrains Mono', monospace;">
                [INFO] Aguardando comando...
            </div>
        </div>
    </div>
</div>
{% endif %}


{% endblock %}

{% block scripts %}
<script>
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    const currentModule = "{{ module or 'malware' }}";

    document.addEventListener('DOMContentLoaded', async () => {
        if (currentModule === 'network') {
            try {
                const resp = await fetch('/api/network/local');
                const ct = resp.headers.get('content-type') || '';
                if (resp.ok) {
                    const data = ct.includes('application/json') ? await resp.json() : JSON.parse(await resp.text());
                    const cidrInput = document.getElementById('network-cidr');
                    if (cidrInput && data.cidr) {
                        cidrInput.value = data.cidr;
                    }
                    const output = document.getElementById('output-network');
                    if (output) {
                        output.innerText = `[INFO] IP: ${data.ip} | M√°scara: ${data.mask} | CIDR sugerido: ${data.cidr}\n` + (output.innerText || "");
                    }
                }
            } catch (e) {
                const output = document.getElementById('output-network');
                if (output) output.innerText = `[WARN] Falha ao detectar IP/CIDR automaticamente: ${e.message}\n` + (output.innerText || "");
            }
        }
    });

    async function handleFileSelect(input) {
        if (input.files.length === 0) return;
        
        const file = input.files[0];
        const output = document.getElementById('output-malware');
        const badge = document.getElementById('status-badge-malware');

        output.innerText = `[INFO] Iniciando upload de: ${file.name} (${(file.size/1024).toFixed(2)} KB)...\n`;
        badge.className = 'status-badge status-running';
        badge.innerText = 'ANALISANDO...';

        const formData = new FormData();
        formData.append('file', file);
        formData.append('csrf_token', csrfToken);

        try {
            const response = await fetch('/api/analyze/file', {
                method: 'POST',
                headers: { 'X-CSRFToken': csrfToken },
                body: formData
            });

            const contentType = response.headers.get('content-type') || '';
            if (!response.ok) {
                const err = contentType.includes('application/json') ? await response.json() : {error: 'Erro no servidor'};
                throw new Error(err.error || 'Erro no servidor');
            }

            const data = await response.json();
            output.innerText += `[SUCCESS] An√°lise conclu√≠da. ID: ${data.result_id}\nRedirecionando...`;
            badge.className = 'status-badge status-success';
            badge.innerText = 'CONCLU√çDO';
            
            setTimeout(() => { window.location.href = `/results/${data.result_id}`; }, 1000);
        } catch (e) {
            output.innerText += `[ERROR] Falha: ${e.message}`;
            badge.className = 'status-badge status-error';
            badge.innerText = 'ERRO';
        }
    }

    async function runNetworkScan(mode) {
        const output = document.getElementById('output-network');
        const badge = document.getElementById('status-badge-network');
        const cidr = document.getElementById('network-cidr').value.trim();
        
        output.innerText = `[INFO] Iniciando varredura ${mode} em ${cidr || 'rede local'}...\n`;
        badge.className = 'status-badge status-running';
        badge.innerText = 'VARRENDO...';

        try {
            const response = await fetch('/api/analyze/network', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify({ mode, cidr: cidr || null })
            });
            
            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.error || 'Erro no servidor');
            }
            const data = await response.json();
            output.innerText += `[SUCCESS] ID: ${data.result_id}\nRedirecionando...`;
            badge.className = 'status-badge status-success';
            badge.innerText = 'FINALIZADO';
            setTimeout(() => { window.location.href = `/results/${data.result_id}`; }, 800);
        } catch (e) {
            output.innerText += `[ERROR] ${e.message}`;
            badge.className = 'status-badge status-error';
            badge.innerText = 'FALHA';
        }
    }

    async function analyzeUrl() {
        const output = document.getElementById('output-url');
        const badge = document.getElementById('status-badge-url');
        const url = document.getElementById('url-input').value.trim();
        if (!url) {
            output.innerText = '[WARN] Informe uma URL v√°lida.';
            return;
        }
        output.innerText = `[INFO] Enviando URL: ${url}\n`;
        badge.className = 'status-badge status-running';
        badge.innerText = 'ANALISANDO...';
        try {
            const resp = await fetch('/api/analyze/url', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify({ url })
            });
            if (!resp.ok) {
                const err = await resp.json();
                throw new Error(err.error || 'Erro no servidor');
            }
            const data = await resp.json();
            output.innerText += `[SUCCESS] ID: ${data.result_id}\nRedirecionando...`;
            badge.className = 'status-badge status-success';
            badge.innerText = 'CONCLU√çDO';
            setTimeout(() => { window.location.href = `/results/${data.result_id}`; }, 900);
        } catch(e) {
            output.innerText += `[ERROR] ${e.message}`;
            badge.className = 'status-badge status-error';
            badge.innerText = 'FALHA';
        }
    }

    async function runAuditScan() {
        const output = document.getElementById('output-audit');
        const badge = document.getElementById('status-badge-audit');
        
        output.innerText = "[INFO] Iniciando auditoria simplificada...\n";
        badge.className = 'status-badge status-running';
        badge.innerText = 'AUDITANDO...';

        try {
            const response = await fetch('/api/scan/audit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify({})
            });
            
            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.error || 'Erro no servidor');
            }
            const data = await response.json();
            output.innerText += `[SUCCESS] Auditoria conclu√≠da. ID: ${data.analysis_id}\nRedirecionando...`;
            badge.className = 'status-badge status-success';
            badge.innerText = 'CONCLU√çDO';
            setTimeout(() => { window.location.href = `/results/${data.analysis_id}`; }, 1000);
        } catch (e) {
            output.innerText += `[ERROR] ${e.message}`;
            badge.className = 'status-badge status-error';
            badge.innerText = 'FALHA';
        }
    }
</script>
{% endblock %}
